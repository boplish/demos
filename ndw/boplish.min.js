function trace(a){"\n"===a[a.length-1]&&(a=a.substring(0,a.length-1)),console.log((performance.now()/1e3).toFixed(3)+": "+a)}var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),createIceServer=function(a,b,c){var d=null,e=a.split(":");if(0===e[0].indexOf("stun"))d={url:a};else if(0===e[0].indexOf("turn")&&(-1!==a.indexOf("transport=udp")||-1===a.indexOf("?transport"))){var f=a.split("?");d={url:f[0],credential:c,username:b}}return d},attachMediaStream=function(a,b){console.log("Attaching media stream"),a.mozSrcObject=b,a.play()},reattachMediaStream=function(a,b){console.log("Reattaching media stream"),a.mozSrcObject=b.mozSrcObject,a.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),createIceServer=function(a,b,c){var d=null,e=a.split(":");if(0===e[0].indexOf("stun"))d={url:a};else if(0===e[0].indexOf("turn"))if(28>webrtcDetectedVersion){var f=a.split("turn:");d={url:"turn:"+b+"@"+f[1],credential:c}}else d={url:a,credential:c,username:b};return d},RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(a,b){"undefined"!=typeof a.srcObject?a.srcObject=b:"undefined"!=typeof a.mozSrcObject?a.mozSrcObject=b:"undefined"!=typeof a.src?a.src=URL.createObjectURL(b):console.log("Error attaching stream to element.")},reattachMediaStream=function(a,b){a.src=b.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):console.log("Browser does not appear to be WebRTC-capable"),BOPlishClient=function(){this.id=sha1.hash(Math.random().toString());var a=new WebSocket("ws://"+window.location.host+"/ws/"+this.id);this._connectionManager=new ConnectionManager,this._router=new Router(this.id,a,this._connectionManager),a.onopen=function(){this._connectionManager.bootstrap(this._router,function(a){console.log(a)},function(a){console.log(a)})}.bind(this)},BOPlishClient.prototype={send:function(a,b,c){this._router.route(a,b,c)},setOnMessageHandler:function(a,b){this._router.registerDeliveryCallback(a,b)},setMonitorCallback:function(a){this._router.registerMonitorCallback(a)},getConnectedPeers:function(){return this._router.getPeerIds()}},ConnectionManager=function(){return this instanceof ConnectionManager?(this._bootstrap=null,this._pending={},this._connections={},this._pcoptions={},this._state="uninitialized",this):new ConnectionManager},ConnectionManager.prototype={utils:{findInSDP:function(a,b){var c=[];return a.split("\r\n").forEach(function(a){a.match(new RegExp("^"+b+"="))&&c.push(a.split("=",2)[1])}),c},findSessionId:function(a){return parseInt(this.findInSDP(a,"o")[0].split(" ")[1],10)}},bootstrap:function(a,b,c){if("uninitialized"!==this._state)return c("Invalid state"),void 0;this._state="bootstrapping",this._router=a;var d=new RTCPeerConnection(this._pcoptions);this._bootstrap={pc:d,dc:d.createDataChannel(null,{}),onsuccess:b,onerror:c},a.registerDeliveryCallback("offer",this._onReceiveOffer.bind(this)),a.registerDeliveryCallback("answer",this._onReceiveAnswer.bind(this)),a.registerDeliveryCallback("denied",this._onOfferDenied.bind(this)),d.createOffer(this._onCreateOfferSuccess.bind(this,d,null,this._bootstrap),this._onCreateOfferError.bind(this,c))},connect:function(a,b,c){if("ready"!==this._state)return c("Invalid state"),void 0;void 0!==this._pending[a]&&c("Already connecting");var d=new RTCPeerConnection(this._pcoptions),e=d.createDataChannel(null,{});this._pending[a]={pc:d,dc:e,onsuccess:b,onerror:c},d.createOffer(this._onCreateOfferSuccess.bind(this,d,a,this._pending[a]),this._onCreateOfferError.bind(this,c))},_onCreateOfferSuccess:function(a,b,c,d){c.drop||(a.setLocalDescription(d),c.offerId=this.utils.findSessionId(d.sdp),this._router.route(b,"offer",{offer:d}))},_onCreateOfferError:function(a,b){a(b)},_onReceiveAnswer:function(a,b){if("bootstrapping"===this._state)this._bootstrap.pc.setRemoteDescription(new RTCSessionDescription(a.answer)),this._bootstrap.dc.onopen=function(){this._router.addPeer(new Peer(b,this._bootstrap.pc,this._bootstrap.dc)),this._state="ready",delete this._bootstrap}.bind(this);else{var c=this._pending[b];if(void 0===c)return;c.pc.setRemoteDescription(new RTCSessionDescription(a.answer)),c.dc.onopen=function(a){var d=new Peer(b,c.pc,a.target);this._router.addPeer(d),"function"==typeof c.onsuccess&&c.onsuccess(),delete this._pending[b],this._connections[b]=d}.bind(this)}},_onReceiveOffer:function(a,b){(void 0!==this._connections[b]||void 0!==this._pending[b])&&this._router.route(b,"denied","");var c=this.utils.findSessionId(a.offer.sdp);if("bootstrapping"===this._state){if(null!==this._bootstrap.pc.remoteDescription)return;if(!(c>this._bootstrap.offerId))return;var d={pc:new RTCPeerConnection(this._pcoptions),onsuccess:this._bootstrap.onsuccess,onerror:this._bootstrap.onerror};this._bootstrap.drop=!0,this._bootstrap=d,this._bootstrap.pc.setRemoteDescription(new RTCSessionDescription(a.offer)),this._bootstrap.pc.ondatachannel=function(a){a.channel.onopen=function(a){var c=new Peer(b,this._bootstrap.pc,a.target);this._router.addPeer(c),this._state="ready",this._bootstrap.onsuccess(),delete this._bootstrap,this._connections[b]=c,delete this._bootstrap}.bind(this)}.bind(this),console.log("creating answer"),this._bootstrap.pc.createAnswer(this._onCreateAnswerSuccess.bind(this,b,this._bootstrap.pc),this._onCreateAnswerError.bind(this))}else{var e=this._pending[b];if(void 0!==e){if(!(c>e.offerId))return;newPendingOffer={onsuccess:e.onsuccess,onerror:e.onerror},e=newPendingOffer,delete this._pending[b]}var f=new RTCPeerConnection(this._pcoptions);f.setRemoteDescription(new RTCSessionDescription(a.offer)),this._pending[b]=e||{},this._pending[b].pc=f,f.ondatachannel=function(a){a.channel.onopen=function(a){var c=new Peer(b,f,a.target);this._router.addPeer(c),"function"==typeof this._pending[b].onsuccess&&this._pending[b].onsuccess(),delete this._pending[b],this._connections[b]=c}.bind(this)}.bind(this),f.createAnswer(this._onCreateAnswerSuccess.bind(this,b,f),this._onCreateAnswerError.bind(this))}},_onCreateAnswerSuccess:function(a,b,c){b.setLocalDescription(new RTCSessionDescription(c)),this._router.route(a,"answer",{answer:c})},_onCreateAnswerError:function(a){console.log(a)},_onOfferDenied:function(){"bootstrapping"===this._state&&(this._bootstrap.pc=new RTCPeerConnection(this._pcoptions),this._bootstrap.dc=this._bootstrap.pc.createDataChannel(null,{}),this._bootstrap.offerId=null)}},"undefined"!=typeof module&&(module.exports=ConnectionManager),Peer=function(a,b,c){return this instanceof Peer?(this.id=a,this.peerConnection=b,this.dataChannel=c,void 0):new Peer(a,b,c)},"undefined"!=typeof module&&(module.exports=Peer),Router=function(a,b,c){return this instanceof Router?(this._peerTable={},this._fallbackSignaling=b,this._fallbackSignaling.onmessage=this.onmessage.bind(this),this._connectionManager=c,this._id=a,this._messageCallbacks={},this._monitorCallback=null,this.registerDeliveryCallback("discovery-answer",this.onDiscoveryAnswerMessage.bind(this)),this.registerDeliveryCallback("discovery-request",this.onDiscoveryRequestMessage.bind(this)),this):new Router},Router.prototype={addPeer:function(a){this._peerTable[a.id]=a,a.dataChannel.onmessage=this.onmessage.bind(this),a.peerConnection.onclosedconnection=this.removePeer.bind(this,a),1===Object.keys(this._peerTable).length&&this.discoverNeighbours(a)},removePeer:function(a){delete this._peerTable[a.id]},getPeerIds:function(){var a,b=[];for(a in this._peerTable)this._peerTable.hasOwnProperty(a)&&b.push(a);return b},onmessage:function(a){try{this.forward(JSON.parse(a.data))}catch(b){throw Error("Unable to parse incoming message "+JSON.stringify(a.data)+": "+b)}},route:function(a,b,c){this.forward({to:a,from:this._id,type:b,payload:c})},forward:function(a){if("function"==typeof this._monitorCallback&&this._monitorCallback(a),this._id===a.to)return this.deliver(a),void 0;var b=this._peerTable[a.to];if(!(b instanceof Peer))return this._fallbackSignaling.send(JSON.stringify(a)),void 0;try{b.dataChannel.send(JSON.stringify(a))}catch(c){throw Error("Unable to route message to "+a.to+" because the DataChannel connection failed.")}},deliver:function(a){if(!this._messageCallbacks[a.type])throw Error("Unable to handle message of type "+a.type+" from "+a.from+" because no callback is registered.");this._messageCallbacks[a.type](a.payload,a.from)},registerDeliveryCallback:function(a,b){this._messageCallbacks[a]=b},registerMonitorCallback:function(a){this._monitorCallback=a},discoverNeighbours:function(a){this.route(a.id,"discovery-request","")},onDiscoveryAnswerMessage:function(a){a.payload;var b;for(b=0;b<a.length;b++)a[b]!==this._id&&this._connectionManager.connect(a[b])},onDiscoveryRequestMessage:function(a,b){var c,d=[];for(c in this._peerTable)this._peerTable.hasOwnProperty(c)&&this._peerTable[c]instanceof Peer&&d.push(c);this.route(b,"discovery-answer",d)}},"undefined"!=typeof module&&(module.exports=Router),sha1=function(a){function b(a){return d(c(e(a)))}function c(a){return g(h(f(a),8*a.length))}function d(a){var b,c,d=m?"0123456789ABCDEF":"0123456789abcdef",e="";for(c=0;c<a.length;c++)b=a.charCodeAt(c),e+=d.charAt(15&b>>>4)+d.charAt(15&b);return e}function e(a){for(var b,c,d="",e=-1;++e<a.length;)b=a.charCodeAt(e),c=e+1<a.length?a.charCodeAt(e+1):0,b>=55296&&56319>=b&&c>=56320&&57343>=c&&(b=65536+((1023&b)<<10)+(1023&c),e++),127>=b?d+=String.fromCharCode(b):2047>=b?d+=String.fromCharCode(192|31&b>>>6,128|63&b):65535>=b?d+=String.fromCharCode(224|15&b>>>12,128|63&b>>>6,128|63&b):2097151>=b&&(d+=String.fromCharCode(240|7&b>>>18,128|63&b>>>12,128|63&b>>>6,128|63&b));return d}function f(a){var b,c=[],d=a.length>>2;for(b=0;d>b;b++)c[b]=0;for(b=0;b<8*a.length;b+=8)c[b>>5]|=(255&a.charCodeAt(b/8))<<24-b%32;return c}function g(a){var b,c="";for(b=0;b<32*a.length;b+=8)c+=String.fromCharCode(255&a[b>>5]>>>24-b%32);return c}function h(a,b){a[b>>5]|=128<<24-b%32,a[(b+64>>9<<4)+15]=b;var c,d,e=new Array(80),f=1732584193,g=-271733879,h=-1732584194,m=271733878,n=-1009589776;for(c=0;c<a.length;c+=16){var o=f,p=g,q=h,r=m,s=n;for(d=0;80>d;d++){e[d]=16>d?a[c+d]:l(e[d-3]^e[d-8]^e[d-14]^e[d-16],1);var t=k(k(l(f,5),i(d,g,h,m)),k(k(n,e[d]),j(d)));n=m,m=h,h=l(g,30),g=f,f=t}f=k(f,o),g=k(g,p),h=k(h,q),m=k(m,r),n=k(n,s)}return[f,g,h,m,n]}function i(a,b,c,d){return 20>a?b&c|~b&d:40>a?b^c^d:60>a?b&c|b&d|c&d:b^c^d}function j(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function k(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function l(a,b){return a<<b|a>>>32-b}var m=0;return a.hash=b,a}("undefined"==typeof exports?{}:exports);